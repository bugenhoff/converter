# Telegram DOC→DOCX Converter Bot

Этот репозиторий содержит Telegram-бота, который принимает файлы в устаревшем формате `.doc`, запускает `LibreOffice` в безголовом режиме и отсылает пользователю документ в формате `.docx` с сохраненным форматированием.

## Быстрый старт

1. Установите зависимости в виртуальном окружении (протестировано на Python 3.13):

   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

2. Установите `LibreOffice` (должен быть доступен в PATH или укажите путь в `LIBREOFFICE_PATH`).
3. Скопируйте `.env.example` → `.env` и заполните значения переменных:

   ```env
   TELEGRAM_BOT_TOKEN=123456:ABCDEF
   LIBREOFFICE_PATH=libreoffice
   TESSDATA_PREFIX=/root/tesseract/tessdata/
   OCR_LANGUAGES=rus+eng+uzb+uzb_cyrl
   GROQ_API_KEY=your_groq_api_key_here
   GROQ_MODEL=llama-3.2-11b-vision-preview
   TEMP_DIR=./tmp
   LOG_LEVEL=INFO
   ```

5. Запустите бота:

   ```bash
   python bot.py
   ```


## Сценарий работы бота

1. Пользователь отправляет один или несколько `.doc` файлов в чат с ботом.
2. Каждый файл скачивается, конвертируется в `.docx` и попадает в очередь; бот отвечает, сколько файлов уже готово.
3. Когда загрузка закончена, пользователь нажимает инлайн-кнопку «Обработка» под ответом бота.
4. Бот собирает все подготовленные `.docx` в один ZIP-архив и присылает его одним сообщением, чтобы не засорять чат.

Если нужно повторить процесс — просто отправьте новые `.doc` файлы и снова нажмите «Обработка».

## Что делает бот

- Приветствует пользователя и объясняет, что он ожидает файл `.doc` и вернет `.docx`.
- Скачивает документ в `TEMP_DIR`, запускает `LibreOffice` для конвертации и возвращает оригинальное содержимое в новом формате.
- Чистит временные файлы и сообщает об ошибках (например, если LibreOffice возвращает код ошибки).

## Структура проекта

- `bot.py` — точка входа.
- `src/config/settings.py` — загрузка `.env` и настройка путей.
- `src/conversion/converter.py` — модуль конвертации через `libreoffice`.
- `src/bot/handlers.py` — Telegram-хендлеры (`/start`, добавление файлов в очередь и inline-кнопка «Обработка»).
- `src/bot/queue.py` — утилиты для хранения очереди файлов на уровне чата.
- `src/bot/batching.py` — сборка ZIP-архива с уже конвертированными документами.
- `src/bot/app.py` — инициализация `python-telegram-bot` и запуск приложения.
- `tests/` — базовый тест на защиту конвертера.

## Тестирование

```bash
pytest
```

## Примечания

- Бот работает в режиме polling и рассчитан на небольшие файлы (по умолчанию до 20 МБ).
- Убедитесь, что `TEMP_DIR` доступен для записи, и присваивайте уникальные имена файлам внутри одного запроса.
- Если LibreOffice установлен через Flatpak (`org.libreoffice.LibreOffice`), бот автоматически запустит его через `flatpak run --command=soffice ...`. При необходимости задайте собственную команду с помощью `LIBREOFFICE_PATH`.
- **PDF обработка**: Бот использует Groq LLM (если настроен) для интеллектуальной обработки PDF документов, с fallback на OCR метод.  
- OCR использует Tesseract. Настройте `TESSDATA_PREFIX` и `OCR_LANGUAGES`, чтобы перечислить доступные языки (по умолчанию `rus+eng+uzb+uzb_cyrl`).